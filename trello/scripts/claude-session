#!/bin/bash
# Claude Code with Trello - Auto Session Linking

TRELLO_SCRIPT="$HOME/.claude-trello/trello-session.sh"
SESSION_CONNECTED=false

# ì¢…ë£Œ ì‹œ ìƒíƒœ ë³€ê²½
cleanup() {
    # ì—°ê²°ëœ ì„¸ì…˜ì´ ìˆëŠ”ì§€ í™•ì¸
    if $TRELLO_SCRIPT connect 2>/dev/null | grep -q "ìë™ ì—°ê²°ë¨"; then
        SESSION_CONNECTED=true
    fi

    if [[ "$SESSION_CONNECTED" == "true" ]]; then
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ ì„¸ì…˜ ì¢…ë£Œ - Trello ìƒíƒœ ë³€ê²½"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "  1) ì¼ì‹œì •ì§€ (ë‚˜ì¤‘ì— ê³„ì†)"
        echo "  2) ì™„ë£Œ"
        echo "  3) ê¸´ê¸‰"
        echo "  4) ìœ ì§€"
        echo "  Enter) ì¼ì‹œì •ì§€"
        echo ""
        read -t 10 -p "ì„ íƒ (10ì´ˆ í›„ ìë™ ì¼ì‹œì •ì§€): " choice

        case "$choice" in
            2)
                $TRELLO_SCRIPT status done
                $TRELLO_SCRIPT comment "ì„¸ì…˜ ì¢…ë£Œ - ì™„ë£Œ ì²˜ë¦¬"
                ;;
            3)
                $TRELLO_SCRIPT status urgent
                $TRELLO_SCRIPT comment "ì„¸ì…˜ ì¢…ë£Œ - ê¸´ê¸‰ìœ¼ë¡œ ë³€ê²½"
                ;;
            4)
                echo "âœ“ ìƒíƒœ ìœ ì§€"
                ;;
            *)
                $TRELLO_SCRIPT status paused
                $TRELLO_SCRIPT comment "ì„¸ì…˜ ì¢…ë£Œ - ì¼ì‹œì •ì§€"
                ;;
        esac
    fi
}

trap cleanup EXIT

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ Claude Code + Trello"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# --continue ë˜ëŠ” --resumeì´ ìˆìœ¼ë©´ ìë™ ì—°ë™ ì‹œë„
if [[ "$*" == *"--continue"* ]] || [[ "$*" == *"--resume"* ]]; then
    echo "ğŸ”„ Trello ì„¸ì…˜ ì—°ê²° ì‹œë„..."
    connect_output=$($TRELLO_SCRIPT connect 2>&1)

    if echo "$connect_output" | grep -q "ìë™ ì—°ê²°ë¨"; then
        SESSION_CONNECTED=true
        echo "$connect_output"

        # ì„¸ì…˜ ì‹œì‘ ê¸°ë¡
        $TRELLO_SCRIPT comment "ì„¸ì…˜ ì‹œì‘ - ì¬ê°œ" 2>/dev/null

        # ìƒíƒœ ë³€ê²½ ì˜µì…˜
        echo ""
        echo "ğŸ’¡ ìƒíƒœ ë³€ê²½? (Enter=ìœ ì§€, u=ê¸´ê¸‰)"
        read -t 3 -n 1 status_input

        case "$status_input" in
            u|U)
                echo ""
                $TRELLO_SCRIPT status urgent
                ;;
            *)
                # ìœ ì§€ (ì•„ë¬´ê²ƒë„ ì•ˆ í•¨)
                ;;
        esac
    else
        echo "â„¹ï¸  ì—°ê²°ëœ ì¹´ë“œ ì—†ìŒ - ì„¸ì…˜ ë‚´ì—ì„œ /trelloë¡œ ìƒì„±í•˜ì„¸ìš”"
    fi
fi

echo ""

# Claude Code ì‹¤í–‰
claude --dangerously-skip-permissions "$@"
